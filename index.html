<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Aspö–Karlskrona Fähre (Aspöleden)</title>
  <style>
    :root{--bg:#0b1220;--card:#121a2b;--muted:#8ba0c6;--accent:#8cc9ff}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif;background:var(--bg);color:#fff}
    .wrap{max-width:860px;margin:0 auto;padding:24px}
    .card{background:var(--card);border:1px solid rgba(255,255,255,.06);border-radius:16px;padding:20px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    h1{font-size:clamp(22px,2.5vw,32px);line-height:1.2;margin:0 0 10px}
    p.lead{color:var(--muted);margin:0 0 16px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.08)}
    th{font-weight:600;text-align:left;color:#bcd0f5}
    .muted{color:var(--muted)}
    .small{font-size:12px}
    .foot{display:flex;justify-content:space-between;gap:10px;align-items:center;margin-top:12px}
    .link{color:var(--accent);text-decoration:none}
    .link:hover{text-decoration:underline}
    .badge{font-size:12px;padding:4px 8px;border-radius:999px;background:rgba(140,201,255,.12);border:1px solid rgba(140,201,255,.35);color:#dff0ff}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Aspö–Karlskrona Fähre</h1>
      <p class="lead">Kostenlose Straßenfähre zwischen Karlskrona und Aspö. Überfahrt ca. 25 Minuten. Unten findest du die heutigen Abfahrten.</p>
      <div id="status" class="small">Lade Daten…</div>
      <div id="tables"></div>
      <div class="foot">
        <span class="badge" id="stamp"></span>
        <a class="link small" href="https://www.trafikverket.se/resa-och-trafik/farjetrafik/aspoleden/" target="_blank" rel="noopener">Quelle: Trafikverket</a>
      </div>
      <div id="notes" class="small muted" style="margin-top:8px"></div>
    </div>
  </div>

<script>
  const fmt = new Intl.DateTimeFormat('de-DE', { hour: '2-digit', minute: '2-digit' });
  function todayISO(d=new Date()){ return d.toISOString().slice(0,10); }

  async function fetchDataFor(dateStr){
    const resp = await fetch('/.netlify/functions/aspo', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ date: dateStr })
    });
    if(!resp.ok) throw new Error('Kunde nicht laden');
    return await resp.json();
  }

  // Försök plocka ut tider från flera möjliga fält/strukturer
  function extractRowsFromRoute(route){
    const rows = [];
    const tt = route?.TimeTable ?? route?.Timetable ?? route?.Times ?? route?.Schedule ?? [];

    const pushRow = (t, dir, from, to) => {
      if(!t) return;
      const d = new Date(t); // funkar om det redan är ISO; annars skippar vi konstiga värden
      if(!isNaN(d)) rows.push({ time: d, dir: dir || `${from||route?.FromHarbour}→${to||route?.ToHarbour}` });
    };

    // 1) Om tt är en array av objekt med välkända fält
    if (Array.isArray(tt)) {
      tt.forEach(item=>{
        // Vanliga kandidater:
        const dep =
          item.DepartureTime || item.Departure || item.Time || item.StartTime || item.Start || item.datetime;
        const dir =
          item.Direction || (item.From && item.To && `${item.From}→${item.To}`);
        pushRow(dep, dir, item.From, item.To);
      });
    } else if (tt && typeof tt === 'object') {
      // 2) Om det ligger i undernycklar, t.ex. { Entries: [...] } eller { Rows: [...] }
      const nestedList = tt.Entries || tt.Rows || tt.Times || tt.Items || [];
      if(Array.isArray(nestedList)){
        nestedList.forEach(item=>{
          const dep =
            item.DepartureTime || item.Departure || item.Time || item.StartTime || item.Start || item.datetime;
          const dir =
            item.Direction || (item.From && item.To && `${item.From}→${item.To}`);
          pushRow(dep, dir, item.From, item.To);
        });
      }
    }

    return rows;
  }

  function parseTRV(json){
    const res = json?.RESPONSE?.RESULT || [];
    const route = res.find(x=>x.FerryRoute)?.FerryRoute?.[0] || {};
    const rows = extractRowsFromRoute(route);

    const annList = (res.find(x=>x.FerryAnnouncement)?.FerryAnnouncement) || [];
    const notes = annList.map(a=>({
      msg: a.Message || '',
      start: a.StartTime? new Date(a.StartTime): null,
      end: a.EndTime? new Date(a.EndTime): null
    }));

    return { rows, notes, debug: json?.debug };
  }

  function render(byDir){
    const tables = document.getElementById('tables');
    const dirKeys = Object.keys(byDir);
    if(!dirKeys.length){
      tables.innerHTML = '<p class="muted">Keine Abfahrten gefunden.</p>';
      return;
    }
    tables.innerHTML = dirKeys.map(k=>{
      const rows = byDir[k];
      const trs = rows.map(r=>`<tr><td>${fmt.format(r.time)}</td><td class="muted">${k}</td></tr>`).join('');
      return `<h3 style="margin:18px 0 6px">${k}</h3><table><thead><tr><th>Abfahrt</th><th class="muted">Richtung</th></tr></thead><tbody>${trs}</tbody></table>`;
    }).join('');
  }

  function groupByDirection(rows){
    const byDir = {};
    rows.forEach(r=>{ const k=r.dir||''; (byDir[k]=byDir[k]||[]).push(r); });
    for(const k in byDir){ byDir[k].sort((a,b)=>a.time-b.time); }
    return byDir;
  }

  (async function(){
    const dateStr = todayISO();
    document.getElementById('stamp').textContent = new Date().toLocaleString('de-DE');
    const statusEl = document.getElementById('status');
    const tables = document.getElementById('tables');

    try{
      const json = await fetchDataFor(dateStr);
      console.log('Rådata från funktionen:', json);

      const data = parseTRV(json);
      const byDir = groupByDirection(data.rows);

      if (data.rows.length === 0) {
        // Visa en liten felsökningsruta om inget hittas
        const diag = `
          <div style="margin-top:8px">
            <div class="small muted">Keine Abfahrten extrahiert. Debug:</div>
            <pre style="white-space:pre-wrap;font-size:12px;color:#9fb3d1;background:#0b1220;border:1px solid rgba(255,255,255,.08);padding:8px;border-radius:8px">
${JSON.stringify({ debug: data.debug, sampleKeys: Object.keys((json?.RESPONSE?.RESULT?.find(r=>r.FerryRoute)?.FerryRoute?.[0]||{})) }, null, 2)}
            </pre>
          </div>`;
        tables.innerHTML = `<p class="muted">Keine Abfahrten gefunden.</p>${diag}`;
      } else {
        render(byDir);
      }

      const notes = document.getElementById('notes');
      if(data.notes?.length){
        notes.innerHTML = data.notes.map(n=>`⚠️ Hinweis: ${n.msg}`).join('<br>');
      }

      statusEl.textContent = 'Daten geladen';
    }catch(e){
      statusEl.textContent = 'Konnte die Daten nicht laden.';
      console.error(e);
    }
  })();
</script>
</body>
</html>
